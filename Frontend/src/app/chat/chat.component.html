<div class="chat-container">
  <h2>Chat 
    <span class="connection-status" [class.connected]="isConnected" [class.disconnected]="!isConnected">
      {{ isConnected ? 'ðŸŸ¢' : 'ðŸ”´' }}
    </span>
  </h2>

  <div class="chat-layout">
    <!-- Conversations List -->
    <div class="conversations-panel">
      <h3>Conversations</h3>
      <div class="conversation-list">
        <div 
          *ngFor="let conv of conversations" 
          class="conversation-item"
          [class.active]="targetUserName === conv.name"
          (click)="selectConversation(conv.name)"
        >
          <div class="conversation-info">
            <strong>{{ conv.name || conv.email }}</strong>
            <small class="last-message">{{ conv.lastMessage }}</small>
          </div>
          <small class="timestamp">{{ conv.lastMessageTime | date:'short' }}</small>
        </div>
        
        <div *ngIf="conversations.length === 0" class="no-conversations">
          No conversations yet
        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel">
      <!-- Manual Username Input (for new chats) -->
      <div class="new-chat-section">
        <label>
          Start new chat - Username:
          <input 
            [(ngModel)]="targetUserName" 
            placeholder="Enter Username to chat" 
            (blur)="loadChatHistory()"
          />
        </label>
      </div>

      <!-- Error Display -->
      <div *ngIf="error" class="error-message">
        {{ error }}
      </div>

      <!-- Chat Messages -->
      <div class="chat-history" *ngIf="targetUserName">
        <div *ngIf="isLoading" class="loading">Loading chat history...</div>
        
        <div *ngFor="let m of messages" class="message-item">
          <p [class.chat-message-user]="isMyMessage(m)" 
             [class.chat-message-friend]="!isMyMessage(m)">
            <strong>{{ getUserDisplayName(m) }}:</strong> 
            {{ m.message }}
            <small class="message-time">({{ m.timestamp | date:'short' }})</small>
          </p>
        </div>

        <div *ngIf="messages.length === 0 && !isLoading" class="no-messages">
          No messages yet. Start the conversation!
        </div>
      </div>

      <!-- Message Input -->
      <div class="message-input-section" *ngIf="targetUserName">
        <div class="message-input-row">
          <input 
            [(ngModel)]="messageText" 
            placeholder="Type your message" 
            (keyup.enter)="sendMessage()"
            class="message-input"
          />
          <button 
            (click)="sendMessage()" 
            [disabled]="!messageText.trim() || !isConnected"
            class="send-button"
          >
            Send
          </button>
        </div>
      </div>

      <div *ngIf="!targetUserName" class="select-user-prompt">
        Select a conversation or enter a Username to start chatting
      </div>
    </div>
  </div>
</div>
